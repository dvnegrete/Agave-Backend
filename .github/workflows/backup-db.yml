name: üîÑ Database Backup to GCS

on:
  schedule:
    # Cada d√≠a a las 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v4

        - name: Install PostgreSQL & GCloud
          run: |
            sudo apt-get update
            sudo apt-get install -y postgresql-client-17 google-cloud-cli

        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ secrets.GCP_SA_KEY }}

        - name: Set up Cloud SDK
          uses: google-github-actions/setup-gcloud@v2

        - name: Create database backup
          env:
            DATABASE_URL: ${{ secrets.DATABASE_URL }}
            GCP_BUCKET_NAME: agave-db-backups
          run: bash .github/scripts/backup-db.sh

        - name: List recent backups
          run: |
            echo "üìã √öltimos 10 backups en GCS:"
            gsutil ls -h gs://agave-db-backups/ | tail -10

        - name: Notify on failure
          if: failure()
          run: |
            echo "‚ùå Database backup failed!"
            echo "Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"